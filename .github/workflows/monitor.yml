name: Monitor

on:
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check and Notify
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          TARGET_USER: ${{ secrets.TARGET_USER }}
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
          CT0: ${{ secrets.CT0 }}
        run: |
          python3 << 'PYEOF'
          import os
          import json
          import re
          import smtplib
          import urllib.request
          from email.mime.text import MIMEText

          target_user = os.environ.get("TARGET_USER", "")
          auth_token = os.environ.get("AUTH_TOKEN", "")
          ct0 = os.environ.get("CT0", "")
          tweet_ids = []
          cookie_expired = False

          def send_email(subject, body):
              email_to = os.environ.get("EMAIL_TO", "")
              email_from = os.environ.get("EMAIL_FROM", "")
              email_password = os.environ.get("EMAIL_PASSWORD", "")
              if email_to and email_from and email_password:
                  try:
                      msg = MIMEText(body, "plain", "utf-8")
                      msg["Subject"] = subject
                      msg["From"] = email_from
                      msg["To"] = email_to
                      server = smtplib.SMTP_SSL("smtp.gmail.com", 465)
                      server.login(email_from, email_password)
                      server.sendmail(email_from, email_to, msg.as_string())
                      server.quit()
                      print("邮件已发送")
                      return True
                  except Exception as e:
                      print(f"邮件发送失败: {e}")
                      return False
              return False

          # 使用 Twitter API 获取用户推文
          def get_user_id(username):
              """获取用户ID"""
              url = f"https://api.twitter.com/graphql/xmU6X_CKVnQ5lSrCbAmJsg/UserByScreenName?variables=%7B%22screen_name%22%3A%22{username}%22%7D&features=%7B%22hidden_profile_subscriptions_enabled%22%3Atrue%2C%22profile_label_improvements_pcf_label_in_post_enabled%22%3Afalse%2C%22rweb_tipjar_consumption_enabled%22%3Atrue%2C%22responsive_web_graphql_exclude_directive_enabled%22%3Atrue%2C%22verified_phone_label_enabled%22%3Afalse%2C%22subscriptions_verification_info_is_identity_verified_enabled%22%3Atrue%2C%22subscriptions_verification_info_verified_since_enabled%22%3Atrue%2C%22highlights_tweets_tab_ui_enabled%22%3Atrue%2C%22responsive_web_twitter_article_notes_tab_enabled%22%3Atrue%2C%22subscriptions_feature_can_gift_premium%22%3Atrue%2C%22creator_subscriptions_tweet_preview_api_enabled%22%3Atrue%2C%22responsive_web_graphql_skip_user_profile_image_extensions_enabled%22%3Afalse%2C%22responsive_web_graphql_timeline_navigation_enabled%22%3Atrue%7D"
              headers = {
                  "Authorization": "Bearer AAAAAAAAAAAAAAAAAAAAANRILgAAAAAAnNwIzUejRCOuH5E6I8xnZz4puTs%3D1Zv7ttfk8LF81IUq16cHjhLTvJu4FA33AGWWjCpTnA",
                  "Cookie": f"auth_token={auth_token}; ct0={ct0}",
                  "X-Csrf-Token": ct0,
                  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",
                  "Content-Type": "application/json",
              }
              try:
                  req = urllib.request.Request(url, headers=headers)
                  resp = urllib.request.urlopen(req, timeout=30)
                  data = json.loads(resp.read().decode("utf-8"))
                  user_id = data["data"]["user"]["result"]["rest_id"]
                  print(f"用户ID: {user_id}")
                  return user_id
              except Exception as e:
                  print(f"获取用户ID失败: {e}")
                  return None

          def get_tweets(user_id):
              """获取用户最新推文"""
              variables = json.dumps({
                  "userId": user_id,
                  "count": 5,
                  "includePromotedContent": False,
                  "withQuickPromoteEligibilityTweetFields": False,
                  "withVoice": True,
                  "withV2Timeline": True
              })
              features = json.dumps({
                  "rweb_tipjar_consumption_enabled": True,
                  "responsive_web_graphql_exclude_directive_enabled": True,
                  "verified_phone_label_enabled": False,
                  "creator_subscriptions_tweet_preview_api_enabled": True,
                  "responsive_web_graphql_timeline_navigation_enabled": True,
                  "responsive_web_graphql_skip_user_profile_image_extensions_enabled": False,
                  "communities_web_enable_tweet_community_results_fetch": True,
                  "c9s_tweet_anatomy_moderator_badge_enabled": True,
                  "articles_preview_enabled": True,
                  "responsive_web_edit_tweet_api_enabled": True,
                  "graphql_is_translatable_rweb_tweet_is_translatable_enabled": True,
                  "view_counts_everywhere_api_enabled": True,
                  "longform_notetweets_consumption_enabled": True,
                  "responsive_web_twitter_article_tweet_consumption_enabled": True,
                  "tweet_awards_web_tipping_enabled": False,
                  "creator_subscriptions_quote_tweet_preview_enabled": False,
                  "freedom_of_speech_not_reach_fetch_enabled": True,
                  "standardized_nudges_misinfo": True,
                  "tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled": True,
                  "rweb_video_timestamps_enabled": True,
                  "longform_notetweets_rich_text_read_enabled": True,
                  "longform_notetweets_inline_media_enabled": True,
                  "responsive_web_enhance_cards_enabled": False
              })
              
              url = f"https://api.twitter.com/graphql/Y4wN5m2LBSVAwwlKSVx9wA/UserTweets?variables={urllib.parse.quote(variables)}&features={urllib.parse.quote(features)}"
              
              headers = {
                  "Authorization": "Bearer AAAAAAAAAAAAAAAAAAAAANRILgAAAAAAnNwIzUejRCOuH5E6I8xnZz4puTs%3D1Zv7ttfk8LF81IUq16cHjhLTvJu4FA33AGWWjCpTnA",
                  "Cookie": f"auth_token={auth_token}; ct0={ct0}",
                  "X-Csrf-Token": ct0,
                  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",
                  "Content-Type": "application/json",
              }
              try:
                  req = urllib.request.Request(url, headers=headers)
                  resp = urllib.request.urlopen(req, timeout=30)
                  data = json.loads(resp.read().decode("utf-8"))
                  return data
              except urllib.error.HTTPError as e:
                  if e.code == 401 or e.code == 403:
                      print(f"认证失败 (HTTP {e.code}): Cookie可能已失效!")
                      return "EXPIRED"
                  print(f"获取推文失败: HTTP {e.code}")
                  return None
              except Exception as e:
                  print(f"获取推文失败: {e}")
                  return None

          def extract_tweet_ids(data):
              """从API返回数据中提取推文ID"""
              ids = []
              try:
                  text = json.dumps(data)
                  matches = re.findall(r'"rest_id"\s*:\s*"(\d{15,25})"', text)
                  # 过滤掉用户ID，只保留推文ID
                  for m in matches:
                      if m not in ids and len(m) >= 18:
                          ids.append(m)
                      if len(ids) >= 5:
                          break
              except:
                  pass
              return ids

          # 记录连续失败次数
          fail_file = "fail_count.json"
          fail_count = 0
          if os.path.exists(fail_file):
              with open(fail_file, "r") as f:
                  fail_count = json.load(f).get("count", 0)

          import urllib.parse

          # 开始执行
          print("=== 获取用户ID ===")
          user_id = get_user_id(target_user)

          if user_id is None:
              print("无法获取用户ID，可能Cookie已失效")
              cookie_expired = True
          else:
              print(f"\n=== 获取推文 ===")
              result = get_tweets(user_id)
              
              if result == "EXPIRED":
                  cookie_expired = True
              elif result is not None:
                  tweet_ids = extract_tweet_ids(result)
                  print(f"提取到推文ID: {tweet_ids}")
              else:
                  print("获取推文返回空")

          # Cookie失效通知
          if cookie_expired:
              fail_count += 1
              print(f"连续失败次数: {fail_count}")
              
              # 连续失败3次才发邮件，避免偶尔的网络问题
              if fail_count >= 3:
                  send_email(
                      "⚠️ 监控异常",
                      "Cookie可能已失效，请重新获取auth_token和ct0并更新GitHub Secrets。\n\n操作步骤:\n1. 浏览器登录x.com\n2. F12 → Application → Cookies → x.com\n3. 复制auth_token和ct0的值\n4. 去GitHub仓库Settings → Secrets更新"
                  )
                  fail_count = 0
              
              with open(fail_file, "w") as f:
                  json.dump({"count": fail_count}, f)
              exit(0)
          else:
              # 成功了，重置失败计数
              fail_count = 0
              with open(fail_file, "w") as f:
                  json.dump({"count": 0}, f)

          if not tweet_ids:
              print("未提取到推文ID")
              exit(0)

          # 读取历史
          history_file = "last_tweets.json"
          old_tweets = []
          first_run = False

          if os.path.exists(history_file):
              with open(history_file, "r") as f:
                  old_tweets = json.load(f)
          else:
              first_run = True

          print(f"上次推文ID: {old_tweets}")

          new_tweets = [t for t in tweet_ids if t not in old_tweets]
          should_send = first_run or len(new_tweets) > 0

          if should_send:
              links = [f"https://x.com/i/status/{tid}" for tid in (new_tweets if new_tweets else tweet_ids)]
              if first_run:
                  body = "监控已启动:\n\n" + "\n".join(links)
              else:
                  body = "检测到新内容:\n\n" + "\n".join(links)
              send_email("页面更新通知", body)
          else:
              print("没有新推文")

          # 保存状态
          with open(history_file, "w") as f:
              json.dump(tweet_ids, f)

          PYEOF

      - name: Save State
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_tweets.json fail_count.json 2>/dev/null || true
          git diff --cached --quiet || git commit -m "update state"
          git push || true
