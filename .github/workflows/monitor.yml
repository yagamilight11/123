name: Monitor

on:
  schedule:
    - cron: '*/3 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: pip install selenium > /dev/null 2>&1

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Setup ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Check and Notify
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          TARGET_USER: ${{ secrets.TARGET_USER }}
        run: |
          python3 << 'PYEOF'
          import os
          import json
          import re
          import smtplib
          import time
          from email.mime.text import MIMEText
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.chrome.service import Service

          target_user = os.environ.get("TARGET_USER", "")

          # 设置无头浏览器
          options = Options()
          options.add_argument("--headless")
          options.add_argument("--no-sandbox")
          options.add_argument("--disable-dev-shm-usage")
          options.add_argument("--disable-gpu")
          options.add_argument("--window-size=1920,1080")
          options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")

          driver = None
          tweet_ids = []

          try:
              driver = webdriver.Chrome(options=options)
              url = f"https://x.com/{target_user}"
              print(f"正在访问: {url}")
              driver.get(url)

              # 等待页面加载
              time.sleep(10)

              html = driver.page_source
              print(f"页面长度: {len(html)}")

              # 提取推文ID
              pattern = rf'/{target_user}/status/(\d+)'
              matches = re.findall(pattern, html, re.IGNORECASE)

              # 去重保留前5条
              seen = []
              for tid in matches:
                  if tid not in seen:
                      seen.append(tid)
                  if len(seen) >= 5:
                      break

              tweet_ids = seen
              print(f"当前推文ID: {tweet_ids}")

          except Exception as e:
              print(f"浏览器访问出错: {e}")
          finally:
              if driver:
                  driver.quit()

          if not tweet_ids:
              print("未获取到推文，退出")
              exit(0)

          # 读取历史记录
          history_file = "last_tweets.json"
          old_tweets = []
          if os.path.exists(history_file):
              with open(history_file, "r") as f:
                  old_tweets = json.load(f)

          print(f"上次推文ID: {old_tweets}")

          # 对比找新推文
          new_tweets = [t for t in tweet_ids if t not in old_tweets]

          if new_tweets:
              print(f"发现 {len(new_tweets)} 条新推文!")

              # 只发URL
              links = [f"https://x.com/i/status/{tid}" for tid in new_tweets]
              body = "检测到新内容:\n\n" + "\n".join(links)

              email_to = os.environ.get("EMAIL_TO", "")
              email_from = os.environ.get("EMAIL_FROM", "")
              email_password = os.environ.get("EMAIL_PASSWORD", "")

              if email_to and email_from and email_password:
                  try:
                      msg = MIMEText(body, "plain", "utf-8")
                      msg["Subject"] = "页面更新通知"
                      msg["From"] = email_from
                      msg["To"] = email_to

                      server = smtplib.SMTP_SSL("smtp.gmail.com", 465)
                      server.login(email_from, email_password)
                      server.sendmail(email_from, email_to, msg.as_string())
                      server.quit()
                      print("邮件已发送")
                  except Exception as e:
                      print(f"邮件发送失败: {e}")
              else:
                  print("邮箱未配置")
                  print(body)
          else:
              print("没有新推文")

          # 保存当前状态
          with open(history_file, "w") as f:
              json.dump(tweet_ids, f)

          PYEOF

      - name: Save State
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_tweets.json 2>/dev/null || true
          git diff --cached --quiet || git commit -m "update state"
          git push || true
